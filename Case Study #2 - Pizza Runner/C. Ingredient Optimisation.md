
### 1. What are the standard ingredients for each pizza?

```sql
WITH CTE AS (
SELECT 
 PIZZA_ID,
UNNEST(REGEXP_MATCHES(TOPPINGS, '[0-9]{1,2}','g'))::INTEGER AS INGREDIENTS
FROM PIZZA_RUNNER.PIZZA_RECIPES
)
-- SELECT * FROM CTE

SELECT 
 N.PIZZA_NAME, 
 STRING_AGG(TOPPING_NAME::TEXT, ', ') AS STANDARD_INGREDIENTS
FROM CTE
INNER JOIN PIZZA_RUNNER.PIZZA_TOPPINGS T
  ON CTE.INGREDIENTS = T.TOPPING_ID
INNER JOIN PIZZA_RUNNER.PIZZA_NAMES N
  ON CTE.PIZZA_ID = N.PIZZA_ID
GROUP BY PIZZA_NAME
```

### 2. What was the most commonly added extra?

```sql
WITH CTE AS (
SELECT 
UNNEST(REGEXP_MATCHES(EXTRAS, '[0-9]{1,2}','g'))::INTEGER AS INGREDIENTS
FROM PIZZA_RUNNER.CUSTOMER_ORDERS
)

SELECT
 TOPPING_NAME, 
 COUNT(*) AS INGREDIENT_COUNT
FROM CTE
INNER JOIN PIZZA_RUNNER.PIZZA_TOPPINGS T ON T.TOPPING_ID = CTE.INGREDIENTS
GROUP BY TOPPING_NAME
ORDER BY 2 DESC
LIMIT 1
'''

### 3. What was the most common exclusion?
#### Same as #2 but with 'Exclusions' column

```sql
WITH CTE AS (
SELECT 
UNNEST(REGEXP_MATCHES(EXCLUSIONS, '[0-9]{1,2}','g'))::INTEGER AS INGREDIENTS
FROM PIZZA_RUNNER.CUSTOMER_ORDERS
)

SELECT
 TOPPING_NAME, 
 COUNT(*) AS INGREDIENT_COUNT
FROM CTE
INNER JOIN PIZZA_RUNNER.PIZZA_TOPPINGS T ON T.TOPPING_ID = CTE.INGREDIENTS
GROUP BY TOPPING_NAME
ORDER BY 2 DESC
LIMIT 1
```

### 4. Generate an order item for each record in the customers_orders table in the format of one of the following:
-- Meat Lovers
-- Meat Lovers - Exclude Beef
-- Meat Lovers - Extra Bacon
-- Meat Lovers - Exclude Cheese, Bacon - Extra Mushroom, Peppers

```sql
WITH CTE1 AS (
SELECT
 ORDER_ID, 
 CUSTOMER_ID,
 PIZZA_ID,
 UNNEST(REGEXP_MATCHES(EXCLUSIONS, '[0-9]{1,3}','g'))::INTEGER AS EXCLUSIONS_INGREDIENTS,
 UNNEST(REGEXP_MATCHES(EXTRAS, '[0-9]{1,3}','g'))::INTEGER AS EXTRAS_INGREDIENTS,
 ORDER_TIME,
-- ADD ROW_NUMBER() to concatenate topping names later on due to a few records being exactly the same
 ROW_NUMBER() OVER () AS ROW_NUM
FROM PIZZA_RUNNER.CUSTOMER_ORDERS

UNION ALL

SELECT
 ORDER_ID, 
 CUSTOMER_ID,
 PIZZA_ID,
 EXCLUSIONS::INTEGER,
 EXTRAS::INTEGER,
 ORDER_TIME, 
 ROW_NUMBER () OVER() AS ROW_NUM
FROM PIZZA_RUNNER.CUSTOMER_ORDERS
WHERE EXCLUSIONS IS NULL AND EXTRAS IS NULL
) 
-- SELECT * FROM CTE1 ORDER BY 1
--SELECT * FROM PIZZA_RUNNER.CUSTOMER_ORDERS
,
-- Concatenate strings to listed number
INGREDIENT_NAMES AS (
SELECT
 C.ORDER_ID, 
 C.CUSTOMER_ID,
 C.PIZZA_ID,
 C.ORDER_TIME,
 N.PIZZA_NAME,
 STRING_AGG(E.TOPPING_NAME, ', ') AS EXCLUSIONS,
 STRING_AGG(E1.TOPPING_NAME, ', ') AS EXTRAS,
 ROW_NUM
FROM CTE1 C
INNER JOIN PIZZA_RUNNER.PIZZA_NAMES N ON N.PIZZA_ID = C.PIZZA_ID
LEFT JOIN PIZZA_RUNNER.PIZZA_TOPPINGS E ON E.TOPPING_ID = C.EXCLUSIONS_INGREDIENTS
LEFT JOIN PIZZA_RUNNER.PIZZA_TOPPINGS E1 ON E1.TOPPING_ID = C.EXTRAS_INGREDIENTS
GROUP BY
 C.ORDER_ID, 
 C.CUSTOMER_ID,
 C.PIZZA_ID,
 C.ORDER_TIME,
 N.PIZZA_NAME,
 C.ROW_NUM
)
-- SELECT * FROM INGREDIENT_NAMES ORDER BY 1
, 
-- CREATE STRINGS FOR INGREDIENTS
EXCLUDE_EXTRA AS (
SELECT
 ORDER_ID, 
 CUSTOMER_ID,
 PIZZA_ID,
 PIZZA_NAME,
 ORDER_TIME,
 CASE
	WHEN EXCLUSIONS IS NULL THEN '' ELSE ' - Exclude ' || EXCLUSIONS END AS EXCLUSIONS, 
 CASE
	WHEN EXTRAS IS NULL THEN '' ELSE ' - Extra ' || EXTRAS END AS EXTRAS 
FROM INGREDIENT_NAMES
)
--  SELECT * FROM EXCLUDE_EXTRA

SELECT
 ORDER_ID, 
 CUSTOMER_ID, 
 PIZZA_ID,  
 ORDER_TIME,
 PIZZA_NAME || EXCLUSIONS || EXTRAS AS ORDER_ITEM
FROM EXCLUDE_EXTRA
ORDER BY 1
```

### 5. Generate an alphabetically ordered comma separated ingredient list for each pizza order 
-- from the customer_orders table and add a 2x in front of any relevant ingredients
-- For example: "Meat Lovers: 2xBacon, Beef, ... , Salami"

```sql
WITH TOPS AS (
SELECT
 PIZZA_ID,
 UNNEST(REGEXP_MATCHES(TOPPINGS, '[0-9]{1,2}','g'))::INTEGER AS TOPPINGS
FROM PIZZA_RUNNER.PIZZA_RECIPES
),

CUST_ORDERS AS (
SELECT
 ORDER_ID, 
 CUSTOMER_ID,
 PIZZA_ID,
 EXCLUSIONS,
 EXTRAS,
-- UNNEST(REGEXP_MATCHES(EXCLUSIONS, '[0-9]{1,3}','g'))::INTEGER AS EXCLUSIONS_INGREDIENTS,
-- UNNEST(REGEXP_MATCHES(EXTRAS, '[0-9]{1,3}','g'))::INTEGER AS EXTRAS_INGREDIENTS,
 ORDER_TIME,
-- ADD ROW_NUMBER() to concatenate topping names later on due to a few records being exactly the same
 ROW_NUMBER() OVER () AS ROW_NUM
FROM PIZZA_RUNNER.CUSTOMER_ORDERS
)
,
-- RETURNS every ingredient as individual record for each pizza order
TOPS2 AS (
SELECT
 C.ORDER_ID,
 C.CUSTOMER_ID,
 C.PIZZA_ID,
 C.ORDER_TIME,
 T.TOPPINGS,
 ROW_NUM
FROM CUST_ORDERS C 
LEFT JOIN TOPS T ON T.PIZZA_ID = C.PIZZA_ID
)
,
-- SELECT * FROM TOPS2
EXCLUSIONS_CTE AS (
SELECT
 ORDER_ID, 
 CUSTOMER_ID,
 PIZZA_ID,
 ORDER_TIME,
 UNNEST(REGEXP_MATCHES(EXCLUSIONS, '[0-9]{1,2}','g'))::INTEGER AS TOPPINGS, 
 ROW_NUM
FROM CUST_ORDERS
WHERE EXCLUSIONS IS NOT NULL
),
-- SELECT * FROM CTE_EXCLUSIONS
-- Separate id's into their own column for any extras
EXTRAS_CTE AS (
SELECT
 ORDER_ID, 
 CUSTOMER_ID,
 PIZZA_ID,
 ORDER_TIME,
 UNNEST(REGEXP_MATCHES(EXTRAS, '[0-9]{1,2}','g'))::INTEGER AS topping_id, 
 ROW_NUM
FROM CUST_ORDERS
WHERE EXTRAS IS NOT NULL
),
-- Combine all of the above with `UNION ALL` to keep repeat toppings that are extras, 
-- but use `EXCEPT` to eliminate repeat toppings that are exclusions
EXCLUSIONS_EXTRAS_ORDERS AS (
  SELECT * FROM TOPS2
  EXCEPT
  SELECT * FROM EXCLUSIONS_CTE
  UNION ALL 
  SELECT * FROM EXTRAS_CTE
)
-- select * from cte_combined_orders ORDER BY 1 
,
ALL_TOPPINGS AS (
SELECT  
 E.ORDER_ID,
 E.CUSTOMER_ID,
 E.PIZZA_ID,
 E.ORDER_TIME,
 E.ROW_NUM,
 E.TOPPINGS,
 N.PIZZA_NAME,
 T.TOPPING_NAME,
 COUNT(E.*) AS TOPPING_COUNT
FROM EXCLUSIONS_EXTRAS_ORDERS AS E
INNER JOIN PIZZA_RUNNER.PIZZA_NAMES AS N ON E.PIZZA_ID = N.PIZZA_ID
INNER JOIN PIZZA_RUNNER.PIZZA_TOPPINGS AS T ON E.TOPPINGS = T.TOPPING_ID
GROUP BY
 E.ORDER_ID,
 E.CUSTOMER_ID,
 E.PIZZA_ID,
 E.ORDER_TIME,
 E.ROW_NUM,
 E.TOPPINGS,
 N.PIZZA_NAME,
 T.TOPPING_NAME
)
-- SELECT * FROM ALL_TOPPINGS

SELECT
 ORDER_ID,
 CUSTOMER_ID,
 PIZZA_ID,
 ORDER_TIME,
 ROW_NUM,
 PIZZA_NAME || ': ' || STRING_AGG(
    CASE
      WHEN TOPPING_COUNT > 1 THEN TOPPING_COUNT || 'x ' || TOPPING_NAME
      ELSE TOPPING_NAME
    END,
  ', '
  ) AS INGREDIENTS
FROM ALL_TOPPINGS
GROUP BY
 ORDER_ID,
 CUSTOMER_ID,
 PIZZA_ID,
 ORDER_TIME,
 ROW_NUM,
 PIZZA_NAME
```

 ### 6. What is the total quantity of each ingredient used in all delivered pizzas sorted by most frequent first?

```sql
WITH TOPS AS (
SELECT
 PIZZA_ID,
 UNNEST(REGEXP_MATCHES(TOPPINGS, '[0-9]{1,2}','g'))::INTEGER AS TOPPINGS
FROM PIZZA_RUNNER.PIZZA_RECIPES
),

CUST_ORDERS AS (
SELECT
 ORDER_ID, 
 CUSTOMER_ID,
 PIZZA_ID,
 EXCLUSIONS,
 EXTRAS,
-- UNNEST(REGEXP_MATCHES(EXCLUSIONS, '[0-9]{1,3}','g'))::INTEGER AS EXCLUSIONS_INGREDIENTS,
-- UNNEST(REGEXP_MATCHES(EXTRAS, '[0-9]{1,3}','g'))::INTEGER AS EXTRAS_INGREDIENTS,
 ORDER_TIME,
-- ADD ROW_NUMBER() to concatenate topping names later on due to a few records being exactly the same
 ROW_NUMBER() OVER () AS ROW_NUM
FROM PIZZA_RUNNER.CUSTOMER_ORDERS
)
,
-- RETURNS every ingredient as individual record for each pizza order
TOPS2 AS (
SELECT
 C.ORDER_ID,
 C.CUSTOMER_ID,
 C.PIZZA_ID,
 C.ORDER_TIME,
 T.TOPPINGS,
 ROW_NUM
FROM CUST_ORDERS C 
LEFT JOIN TOPS T ON T.PIZZA_ID = C.PIZZA_ID
)
,
-- SELECT * FROM TOPS2
EXCLUSIONS_CTE AS (
SELECT
 ORDER_ID, 
 CUSTOMER_ID,
 PIZZA_ID,
 ORDER_TIME,
 UNNEST(REGEXP_MATCHES(EXCLUSIONS, '[0-9]{1,2}','g'))::INTEGER AS TOPPINGS, 
 ROW_NUM
FROM CUST_ORDERS
WHERE EXCLUSIONS IS NOT NULL
),
-- SELECT * FROM CTE_EXCLUSIONS
-- Separate id's into their own column for any extras
EXTRAS_CTE AS (
SELECT
 ORDER_ID, 
 CUSTOMER_ID,
 PIZZA_ID,
 ORDER_TIME,
 UNNEST(REGEXP_MATCHES(EXTRAS, '[0-9]{1,2}','g'))::INTEGER AS topping_id, 
 ROW_NUM
FROM CUST_ORDERS
WHERE EXTRAS IS NOT NULL
),
-- Combine all of the above with `UNION ALL` to keep repeat toppings that are extras, 
-- but use `EXCEPT` to eliminate repeat toppings that are exclusions
EXCLUSIONS_EXTRAS_ORDERS AS (
  SELECT * FROM TOPS2
  EXCEPT
  SELECT * FROM EXCLUSIONS_CTE
  UNION ALL 
  SELECT * FROM EXTRAS_CTE
)
-- select * from cte_combined_orders ORDER BY 1 
,
ALL_TOPPINGS AS (
SELECT  
 E.ORDER_ID,
 E.CUSTOMER_ID,
 E.PIZZA_ID,
 E.ORDER_TIME,
 E.ROW_NUM,
 E.TOPPINGS,
 N.PIZZA_NAME,
 T.TOPPING_NAME,
 COUNT(E.*) AS TOPPING_COUNT
FROM EXCLUSIONS_EXTRAS_ORDERS AS E
INNER JOIN PIZZA_RUNNER.PIZZA_NAMES AS N ON E.PIZZA_ID = N.PIZZA_ID
INNER JOIN PIZZA_RUNNER.PIZZA_TOPPINGS AS T ON E.TOPPINGS = T.TOPPING_ID
GROUP BY
 E.ORDER_ID,
 E.CUSTOMER_ID,
 E.PIZZA_ID,
 E.ORDER_TIME,
 E.ROW_NUM,
 E.TOPPINGS,
 N.PIZZA_NAME,
 T.TOPPING_NAME
)

SELECT
 TOPPING_NAME, 
 SUM(TOPPING_COUNT) AS INGREDIENT_QUANTITY
FROM ALL_TOPPINGS
GROUP BY TOPPING_NAME
ORDER BY INGREDIENT_QUANTITY DESC
```
